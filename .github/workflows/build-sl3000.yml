name: ğŸš€ ç¼–è¯‘ ImmortalWrt æœ€æ–°ç¨³å®šç‰ˆ

on:
  workflow_dispatch:
    inputs:
      target_device:
        description: "ç›®æ ‡è®¾å¤‡"
        required: true
        default: "mediatek/filogic"
        type: choice
        options:
          - mediatek/filogic
          - qualcomm/ipq60xx
          - rockchip/armv8
          - x86/64
      clean_build:
        description: "æ˜¯å¦å®Œå…¨æ¸…ç†ç¼–è¯‘"
        default: false
        type: boolean
      multithreading:
        description: "æ˜¯å¦å¼€å¯å¤šçº¿ç¨‹ç¼–è¯‘"
        default: false
        type: boolean
      include_luci:
        description: "æ˜¯å¦åŒ…å« Luci Web ç•Œé¢"
        default: true
        type: boolean

env:
  CCACHE_DIR: ${{ github.workspace }}/ccache
  FORCE_UNSAFE_CONFIGURE: 1
  TERM: linux

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      immortalwrt_branch: ${{ steps.get_branch.outputs.branch }}
      branch_version: ${{ steps.get_branch.outputs.version }}
    steps:
      - name: ğŸ” è·å–æœ€æ–°ç¨³å®šç‰ˆåˆ†æ”¯
        id: get_branch
        run: |
          LATEST_STABLE="openwrt-24.10"
          echo "branch=$LATEST_STABLE" >> $GITHUB_OUTPUT
          VERSION=$(echo $LATEST_STABLE | sed 's/openwrt-//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… ä½¿ç”¨ç¨³å®šç‰ˆ: $LATEST_STABLE (ç‰ˆæœ¬ $VERSION)"

  build:
    runs-on: ubuntu-22.04
    needs: setup
    timeout-minutes: 240
    
    steps:
      - name: ğŸ“‹ æ˜¾ç¤ºç¼–è¯‘ä¿¡æ¯
        run: |
          echo "=== ImmortalWrt ç¼–è¯‘ä¿¡æ¯ ==="
          echo "ç›®æ ‡è®¾å¤‡: ${{ github.event.inputs.target_device }}"
          echo "ImmortalWrt åˆ†æ”¯: ${{ needs.setup.outputs.immortalwrt_branch }}"
          echo "å›ºä»¶ç‰ˆæœ¬: ${{ needs.setup.outputs.branch_version }}"
          echo "å¤šçº¿ç¨‹ç¼–è¯‘: ${{ github.event.inputs.multithreading }}"
          echo "åŒ…å« Luci: ${{ github.event.inputs.include_luci }}"

      - name: â¬ æ£€æŸ¥ç³»ç»Ÿèµ„æº
        run: |
          echo "=== ç³»ç»Ÿèµ„æºä¿¡æ¯ ==="
          echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
          echo "å†…å­˜:"
          free -h
          echo "ç£ç›˜:"
          df -h

      - name: âœ… Checkout ç”¨æˆ·é…ç½®ä»“åº“
        uses: actions/checkout@v4
        with:
          path: user-configs

      - name: âœ… Checkout ImmortalWrt æºç 
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: ${{ needs.setup.outputs.immortalwrt_branch }}
          path: immortalwrt

      - name: ğŸ“ åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p immortalwrt
          mkdir -p ccache

      - name: ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential clang flex bison g++ gawk gcc-multilib gettext git \
            libncurses-dev libssl-dev python3 python3-pip python3-serial \
            unzip zlib1g-dev file wget rsync curl \
            ccache ecj cmake ninja-build libxml2-utils

      - name: ğŸ”§ é…ç½®ç¼–è¯‘ç¯å¢ƒ
        run: |
          ccache -M 2G
          ccache -s

      - name: ğŸ“¦ å¤åˆ¶ç”¨æˆ·é…ç½®æ–‡ä»¶
        run: |
          echo "å¤åˆ¶ç”¨æˆ·é…ç½®æ–‡ä»¶..."
          if [ -f "user-configs/.config" ]; then
            cp -f user-configs/.config immortalwrt/
            echo "âœ… å·²å¤åˆ¶ .config æ–‡ä»¶"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ç”¨æˆ· .configï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
          fi
          
          if [ -f "user-configs/diy.sh" ]; then
            cp -f user-configs/diy.sh immortalwrt/
            chmod +x immortalwrt/diy.sh
            echo "âœ… å·²å¤åˆ¶ diy.sh"
          fi
          
          if [ -d "user-configs/files" ]; then
            cp -rf user-configs/files immortalwrt/
            echo "âœ… å·²å¤åˆ¶ files ç›®å½•"
          fi

      - name: ğŸ§¹ æ¸…ç†ç¼–è¯‘ç¯å¢ƒ
        if: ${{ github.event.inputs.clean_build == 'true' }}
        working-directory: immortalwrt
        run: |
          echo "æ‰§è¡Œå®Œå…¨æ¸…ç†..."
          make dirclean || true
          rm -rf tmp/ staging_dir/ build_dir/ bin/

      - name: ğŸš€ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
        working-directory: immortalwrt
        run: |
          if [ -f "diy.sh" ]; then
            echo "æ‰§è¡Œç”¨æˆ· diy.sh è„šæœ¬..."
            ./diy.sh
          fi

      - name: ğŸ”„ æ›´æ–°å’Œå®‰è£… feeds
        working-directory: immortalwrt
        run: |
          echo "æ›´æ–° feeds..."
          ./scripts/feeds update -a
          echo "å®‰è£… feeds..."
          ./scripts/feeds install -a
          
          if [ "${{ github.event.inputs.include_luci }}" = "true" ]; then
            echo "å®‰è£… Luci ç›¸å…³ç»„ä»¶..."
            ./scripts/feeds install luci
            ./scripts/feeds install luci-base
          fi

      - name: âš™ï¸ ç”ŸæˆåŸºç¡€é…ç½®
        working-directory: immortalwrt
        run: |
          echo "ç”ŸæˆåŸºç¡€é…ç½®..."
          
          # å¦‚æœå·²æœ‰é…ç½®ï¼Œä½¿ç”¨ç°æœ‰é…ç½®
          if [ -f ".config" ]; then
            echo "ä½¿ç”¨ç°æœ‰ .config æ–‡ä»¶"
            make defconfig
            exit 0
          fi
          
          echo "åˆ›å»ºé»˜è®¤é…ç½®..."
          
          # æ ¹æ®è®¾å¤‡ç±»å‹ç”Ÿæˆé…ç½®
          DEVICE="${{ github.event.inputs.target_device }}"
          
          if [ "$DEVICE" = "mediatek/filogic" ]; then
            echo "é…ç½®ä¸º MediaTek Filogic è®¾å¤‡"
            echo "CONFIG_TARGET_mediatek=y" > .config
            echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
            echo "CONFIG_TARGET_mediatek_filogic_DEVICE_glinet_gl-mt6000=y" >> .config
          elif [ "$DEVICE" = "qualcomm/ipq60xx" ]; then
            echo "é…ç½®ä¸º Qualcomm IPQ60xx è®¾å¤‡"
            echo "CONFIG_TARGET_qualcommax=y" > .config
            echo "CONFIG_TARGET_qualcommax_ipq60xx=y" >> .config
          elif [ "$DEVICE" = "rockchip/armv8" ]; then
            echo "é…ç½®ä¸º Rockchip ARMv8 è®¾å¤‡"
            echo "CONFIG_TARGET_rockchip=y" > .config
            echo "CONFIG_TARGET_rockchip_armv8=y" >> .config
          elif [ "$DEVICE" = "x86/64" ]; then
            echo "é…ç½®ä¸º x86/64 è®¾å¤‡"
            echo "CONFIG_TARGET_x86=y" > .config
            echo "CONFIG_TARGET_x86_64=y" >> .config
          else
            echo "âŒ æœªçŸ¥è®¾å¤‡ç±»å‹: $DEVICE"
            exit 1
          fi
          
          # æ·»åŠ  Luci é…ç½®
          if [ "${{ github.event.inputs.include_luci }}" = "true" ]; then
            echo "CONFIG_PACKAGE_luci=y" >> .config
            echo "CONFIG_PACKAGE_luci-base=y" >> .config
          fi
          
          echo "åº”ç”¨é…ç½®..."
          make defconfig

      - name: ğŸ“¥ é¢„ä¸‹è½½æºç åŒ…
        working-directory: immortalwrt
        timeout-minutes: 30
        run: |
          echo "é¢„ä¸‹è½½æºç åŒ…..."
          make download -j$(nproc) || make download -j1
          
          echo "æ£€æŸ¥ä¸‹è½½å®Œæ•´æ€§..."
          # åˆ é™¤å¯èƒ½ä¸å®Œæ•´çš„æ–‡ä»¶å¹¶é‡æ–°ä¸‹è½½
          find dl -size -1k -name "*.gz" -o -name "*.bz2" -o -name "*.xz" | xargs rm -f 2>/dev/null || true
          make download -j$(nproc)

      - name: ğŸ—ï¸ ç¼–è¯‘å·¥å…·é“¾
        working-directory: immortalwrt
        timeout-minutes: 120
        run: |
          echo "=== ç¼–è¯‘å·¥å…·é“¾ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          echo "ç¼–è¯‘åŸºç¡€å·¥å…·..."
          make -j1 tools/compile
          
          echo "ç¼–è¯‘å·¥å…·é“¾..."
          make -j1 toolchain/compile
          
          # éªŒè¯å·¥å…·é“¾
          if [ -d "staging_dir/toolchain-" ] && [ -f "staging_dir/toolchain-"*/bin/*-gcc ]; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
            echo "å·¥å…·é“¾ä½ç½®: staging_dir/toolchain-*/bin/"
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
          
          echo "å®Œæˆæ—¶é—´: $(date)"

      - name: ğŸ§± ä¸»ç¼–è¯‘è¿‡ç¨‹
        working-directory: immortalwrt
        timeout-minutes: 180
        run: |
          echo "=== å¼€å§‹ä¸»ç¼–è¯‘ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          if [ "${{ github.event.inputs.multithreading }}" = "true" ]; then
            JOBS=$(($(nproc) - 1))
            echo "ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘ (-j$JOBS)..."
            make -j$JOBS V=s
          else
            echo "ä½¿ç”¨å•çº¿ç¨‹ç¼–è¯‘ (-j1)..."
            make -j1 V=s
          fi
          
          echo "å®Œæˆæ—¶é—´: $(date)"

      - name: ğŸ“Š ä¿å­˜ç¼–è¯‘é…ç½®
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-config-${{ needs.setup.outputs.branch_version }}
          path: |
            immortalwrt/.config
            immortalwrt/feeds.conf.default
          retention-days: 7

      - name: ğŸ“ ä¿å­˜ç¼–è¯‘æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ needs.setup.outputs.branch_version }}
          path: |
            immortalwrt/logs/
          retention-days: 3

      - name: ğŸ“¦ ä¸Šä¼ å›ºä»¶æ–‡ä»¶
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ needs.setup.outputs.branch_version }}
          path: |
            immortalwrt/bin/targets/**/*
          retention-days: 30

      - name: ğŸ’¾ ä¿å­˜ç¼–è¯‘ç¼“å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ccache-cache
          path: ccache
          retention-days: 2

      - name: ğŸ‰ ç¼–è¯‘å®Œæˆæ‘˜è¦
        if: always()
        run: |
          echo "=== ç¼–è¯‘ç»“æœæ‘˜è¦ ==="
          echo "ImmortalWrt ç‰ˆæœ¬: ${{ needs.setup.outputs.immortalwrt_branch }}"
          echo "ç›®æ ‡è®¾å¤‡: ${{ github.event.inputs.target_device }}"
          echo "ç¼–è¯‘æ—¶é—´: $(date)"
          
          if [ -d "immortalwrt/bin/targets" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
            echo "ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶:"
            find immortalwrt/bin/targets -name "*.bin" -o -name "*.img" -o -name "*.gz" | head -10
            echo ""
            echo "å›ºä»¶ä½ç½®: immortalwrt/bin/targets/"
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            echo "è¯·æŸ¥çœ‹ build-logs æ—¥å¿—æ–‡ä»¶åˆ†æé—®é¢˜"
          fi

  diagnostics:
    runs-on: ubuntu-22.04
    if: failure()
    needs: [setup, build]
    steps:
      - name: ğŸ“‹ ç¼–è¯‘å¤±è´¥åˆ†æ
        run: |
          echo "=== ç¼–è¯‘å¤±è´¥åˆ†æ ==="
          echo "ImmortalWrt ç‰ˆæœ¬: ${{ needs.setup.outputs.immortalwrt_branch }}"
          echo ""
          echo "å¸¸è§é—®é¢˜æ’æŸ¥:"
          echo "1. ä¾èµ–ç¼ºå¤±: æ£€æŸ¥ feeds æ˜¯å¦å®Œæ•´å®‰è£…"
          echo "2. å·¥å…·é“¾é—®é¢˜: ç¡®è®¤å·¥å…·é“¾ç¼–è¯‘æ˜¯å¦æˆåŠŸ" 
          echo "3. å†…å­˜ä¸è¶³: å°è¯•å…³é—­å¤šçº¿ç¨‹ç¼–è¯‘"
          echo "4. ç½‘ç»œè¶…æ—¶: æ£€æŸ¥ä¸‹è½½çš„æºç åŒ…æ˜¯å¦å®Œæ•´"
          echo ""
          echo "ä¿®å¤å»ºè®®:"
          echo "- å¯ç”¨å®Œå…¨æ¸…ç†ç¼–è¯‘ (clean_build: true)"
          echo "- å…³é—­å¤šçº¿ç¨‹ç¼–è¯‘ (multithreading: false)"
          echo "- æ£€æŸ¥ .config æ–‡ä»¶é…ç½®æ˜¯å¦æ­£ç¡®"
