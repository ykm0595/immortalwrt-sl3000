name: ğŸš€ ç¼–è¯‘ ImmortalWRT

on:
  workflow_dispatch:
    inputs:
      owner:
        description: "openWRT ä»“åº“çš„æ‹¥æœ‰è€…"
        type: string
        required: true
        default: "immortalwrt"
      repo:
        description: "openWRT ä»“åº“çš„åå­—"
        type: string
        required: true
        default: "immortalwrt"
      branch:
        description: "openWRT ä»“åº“çš„åˆ†æ”¯"
        type: string
        required: true
        default: "openwrt-24.10"
      multithreading:
        description: "å¼€å¯å¤šçº¿ç¨‹ç¼–è¯‘"
        type: boolean
        default: true
      ssh:
        description: "ä½¿ç”¨ ssh è¿æ¥åˆ°ç¼–è¯‘ç¯å¢ƒ"
        type: boolean
        default: false
      isFiles:
        description: "ä½¿ç”¨fileså¤§æ³•"
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    name: ğŸš€ ç¼–è¯‘ ImmortalWRT
    
    steps:
      - name: ğŸ“Š ç¼–è¯‘å¼€å§‹ä¿¡æ¯
        run: |
          echo "=========================================="
          echo "ğŸš€ å¼€å§‹ ImmortalWRT ç¼–è¯‘"
          echo "è¶…æ—¶: 360åˆ†é’Ÿ"
          echo "=========================================="

      - name: ğŸ—‘ï¸ é˜¶æ®µ1: åŸºç¡€æ¸…ç†
        run: |
          echo "å¼€å§‹ç¬¬ä¸€é˜¶æ®µæ¸…ç†..."
          sudo sync
          sudo sysctl -w vm.drop_caches=3
          sudo find /tmp -type f -atime +0 -delete 2>/dev/null || true
          sudo find /var/tmp -type f -atime +0 -delete 2>/dev/null || true
          sudo journalctl --vacuum-time=1h
          sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \;
          echo "ç¬¬ä¸€é˜¶æ®µæ¸…ç†å®Œæˆ"

      - name: ğŸ—‘ï¸ é˜¶æ®µ2: åŒ…ç®¡ç†å™¨æ¸…ç†
        run: |
          echo "å¼€å§‹åŒ…ç®¡ç†å™¨æ¸…ç†..."
          sudo apt autoclean
          sudo apt autoremove -y --purge
          sudo rm -rf /var/lib/apt/lists/*
          sudo rm -rf /var/cache/apt/archives/*
          if command -v pip >/dev/null; then
            python3 -m pip cache purge 2>/dev/null || true
          fi
          if command -v npm >/dev/null; then
            npm cache clean --force 2>/dev/null || true
          fi
          echo "åŒ…ç®¡ç†å™¨æ¸…ç†å®Œæˆ"

      - name: ğŸ—‘ï¸ é˜¶æ®µ3: æ·±åº¦æ¸…ç†
        run: |
          echo "å¼€å§‹æ·±åº¦æ¸…ç†..."
          sudo find /usr/share/doc -depth -type f ! -name copyright -delete 2>/dev/null || true
          sudo find /usr/share/doc -empty -delete 2>/dev/null || true
          sudo rm -rf /usr/share/man/* /usr/share/groff/* /usr/share/info/*
          sudo find /usr/share/locale -mindepth 1 -maxdepth 1 ! -name 'en*' ! -name 'zh*' -exec rm -rf {} + 2>/dev/null || true
          sudo apt remove -y --purge azure-cli google-cloud-sdk firefox microsoft-edge-stable 2>/dev/null || true
          echo "æ·±åº¦æ¸…ç†å®Œæˆ"

      - name: âš¡ è¶…çº§ç£ç›˜ä¼˜åŒ–
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 1024
          swap-size-mb: 0
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          remove-codeql: "true"
          remove-docker-images: "true"

      - name: ğŸ“ˆ èµ„æºçŠ¶æ€æŠ¥å‘Š
        run: |
          echo "=========================================="
          echo "ğŸ“Š ä¼˜åŒ–åèµ„æºçŠ¶æ€"
          echo "=========================================="
          df -hT
          echo "------------------------------------------"
          free -h
          echo "------------------------------------------"
          echo "CPUä¿¡æ¯:"
          nproc
          echo "------------------------------------------"
          AVAILABLE_GB=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
          echo "âœ… å¯ç”¨ç£ç›˜ç©ºé—´: ${AVAILABLE_GB}GB"

      - name: ğŸ“¦ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          echo "å®‰è£…ç¼–è¯‘ä¾èµ–..."
          sudo apt update
          sudo apt install -y build-essential ccache clang cmake gcc-multilib g++-multilib \
            git libncurses-dev libssl-dev libelf-dev python3 python3-pip rsync subversion \
            swig unzip wget ack antlr3 asciidoc autoconf automake autopoint binutils bison \
            bzip2 cpio curl device-tree-compiler ecj fastjar flex gawk gettext gnutls-dev \
            gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libglib2.0-dev \
            libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libpython3-dev libreadline-dev \
            libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano ninja-build \
            p7zip p7zip-full patch pkgconf python3-ply python3-docutils python3-pyelftools \
            qemu-utils re2c scons squashfs-tools texinfo uglifyjs upx-ucl vim xmlto xxd \
            zlib1g-dev zstd

      - name: ğŸ“¥ å…‹éš†å½“å‰ä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ“¥ å…‹éš† ImmortalWRT
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.owner }}/${{ inputs.repo }}
          ref: ${{ inputs.branch }}
          path: openWRT

      - name: ğŸ“‹ å¤åˆ¶é…ç½®æ–‡ä»¶
        run: |
          cp -f .config diy.sh openWRT/
          if [ "${{ inputs.isFiles }}" = "true" ]; then
            cp -rf files openWRT/ 2>/dev/null || true
          fi

      - name: âš™ï¸ è¿è¡Œè‡ªå®šä¹‰è„šæœ¬
        working-directory: openWRT
        run: |
          if [ -f "diy.sh" ]; then
            chmod +x diy.sh
            ./diy.sh
          fi

      - name: ğŸ“¥ æ›´æ–°å’Œå®‰è£… Feeds
        working-directory: openWRT
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ğŸš¨ SSH è°ƒè¯•ä¼šè¯
        if: ${{ inputs.ssh == true }}
        uses: mxschmitt/action-tmate@v3

      - name: ğŸ”§ ç¼–è¯‘å‰é…ç½®ä¼˜åŒ–
        working-directory: openWRT
        run: |
          echo "ä¼˜åŒ–ç¼–è¯‘é…ç½®..."
          sed -i 's/CONFIG_DEBUG_INFO=y/CONFIG_DEBUG_INFO=n/' .config 2>/dev/null || true
          echo "CONFIG_CCACHE=y" >> .config
          make defconfig

      - name: â° ç¼–è¯‘è¶…æ—¶ä¿æŠ¤
        timeout-minutes: 360

      - name: ğŸ› ï¸ ç¼–è¯‘ ImmortalWRT
        working-directory: openWRT
        run: |
          set +e
          for attempt in 1 2 3; do
            echo "ç¼–è¯‘å°è¯• $attempt/3"
            if [ "${{ inputs.multithreading }}" = "true" ]; then
              make -j$(nproc) V=s
            else
              make -j1 V=s
            fi
            
            if [ $? -eq 0 ]; then
              echo "âœ… ç¼–è¯‘æˆåŠŸ!"
              break
            else
              echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œå°è¯• $attempt/3"
              if [ $attempt -lt 3 ]; then
                echo "ç­‰å¾…10ç§’åé‡è¯•..."
                sleep 10
                echo "æ¸…ç†ç¼–è¯‘ç¯å¢ƒ..."
                make clean
              else
                echo "âŒ æ‰€æœ‰ç¼–è¯‘å°è¯•å‡å¤±è´¥"
                exit 1
              fi
            fi
          done
          set -e

      - name: ğŸ’¾ ä¸Šä¼ ç¼–è¯‘ç»“æœ
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-build-result
          path: openWRT/bin/targets/
          retention-days: 30

      - name: ğŸ“‹ æœ€ç»ˆæŠ¥å‘Š
        if: always()
        run: |
          echo "ç¼–è¯‘å®Œæˆ!"
          if [ -d "openWRT/bin/targets" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸ!"
            find openWRT/bin/targets -name "*.bin" -o -name "*.img" | head -5
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
          fi
