name: ğŸš€ ç¼–è¯‘ ImmortalWrt æœ€æ–°ç¨³å®šç‰ˆ

on:
  workflow_dispatch:
    inputs:
      target_device:
        description: "ç›®æ ‡è®¾å¤‡"
        required: true
        default: "mediatek/filogic"
        type: choice
        options:
          - mediatek/filogic
          - qualcomm/ipq60xx
          - rockchip/armv8
          - x86/64
      clean_build:
        description: "æ˜¯å¦å®Œå…¨æ¸…ç†ç¼–è¯‘"
        default: false
        type: boolean
      multithreading:
        description: "æ˜¯å¦å¼€å¯å¤šçº¿ç¨‹ç¼–è¯‘"
        default: false
        type: boolean
      include_luci:
        description: "æ˜¯å¦åŒ…å« Luci Web ç•Œé¢"
        default: true
        type: boolean
      ssh_debug:
        description: "æ˜¯å¦å¼€å¯ SSH è°ƒè¯•"
        default: false
        type: boolean

env:
  CCACHE_DIR: ${{ github.workspace }}/ccache
  FORCE_UNSAFE_CONFIGURE: 1
  TERM: linux

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      immortalwrt_branch: ${{ steps.get_branch.outputs.branch }}
      branch_version: ${{ steps.get_branch.outputs.version }}
    steps:
      - name: ğŸ” è·å–æœ€æ–°ç¨³å®šç‰ˆåˆ†æ”¯
        id: get_branch
        run: |
          LATEST_STABLE="openwrt-24.10"
          echo "branch=$LATEST_STABLE" >> $GITHUB_OUTPUT
          VERSION=$(echo $LATEST_STABLE | sed 's/openwrt-//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… ä½¿ç”¨ç¨³å®šç‰ˆ: $LATEST_STABLE (ç‰ˆæœ¬ $VERSION)"

  build:
    runs-on: ubuntu-22.04
    needs: setup
    timeout-minutes: 240
    
    steps:
      - name: ğŸ“‹ æ˜¾ç¤ºç¼–è¯‘ä¿¡æ¯
        run: |
          echo "=== ImmortalWrt ç¼–è¯‘ä¿¡æ¯ ==="
          echo "ç›®æ ‡è®¾å¤‡: ${{ github.event.inputs.target_device }}"
          echo "ImmortalWrt åˆ†æ”¯: ${{ needs.setup.outputs.immortalwrt_branch }}"
          echo "å›ºä»¶ç‰ˆæœ¬: ${{ needs.setup.outputs.branch_version }}"
          echo "å¤šçº¿ç¨‹ç¼–è¯‘: ${{ github.event.inputs.multithreading }}"
          echo "åŒ…å« Luci: ${{ github.event.inputs.include_luci }}"

      - name: â¬ æ£€æŸ¥ç³»ç»Ÿèµ„æº
        run: |
          echo "=== ç³»ç»Ÿèµ„æºä¿¡æ¯ ==="
          echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
          free -h
          df -h

      - name: âœ… Checkout ç”¨æˆ·é…ç½®ä»“åº“
        uses: actions/checkout@v4
        with:
          path: user-configs

      - name: âœ… Checkout ImmortalWrt æºç 
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: ${{ needs.setup.outputs.immortalwrt_branch }}
          path: immortalwrt

      - name: ğŸ“ åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p immortalwrt
          mkdir -p ccache

      - name: ğŸ› ï¸ å®‰è£…å®Œæ•´ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential clang flex bison g++ gawk gcc-multilib gettext git \
            libncurses-dev libssl-dev python3 python3-pip python3-serial \
            unzip zlib1g-dev file wget rsync curl \
            ccache ecj cmake ninja-build libxml2-utils

      - name: ğŸ”§ é…ç½®ç¼–è¯‘ç¯å¢ƒå’Œç¼“å­˜
        run: |
          ccache -M 2G
          ccache -s

      - name: ğŸ“¦ å¤åˆ¶ç”¨æˆ·é…ç½®æ–‡ä»¶
        run: |
          echo "å¤åˆ¶ç”¨æˆ·é…ç½®æ–‡ä»¶..."
          if [ -f "user-configs/.config" ]; then
            cp -f user-configs/.config immortalwrt/
            echo "âœ… å·²å¤åˆ¶ .config æ–‡ä»¶"
          fi
          
          if [ -f "user-configs/diy.sh" ]; then
            cp -f user-configs/diy.sh immortalwrt/
            chmod +x immortalwrt/diy.sh
            echo "âœ… å·²å¤åˆ¶ diy.sh"
          fi
          
          if [ -d "user-configs/files" ]; then
            cp -rf user-configs/files immortalwrt/
            echo "âœ… å·²å¤åˆ¶ files ç›®å½•"
          fi

      - name: ğŸ§¹ æ¸…ç†ç¼–è¯‘ç¯å¢ƒ
        if: ${{ github.event.inputs.clean_build == 'true' }}
        working-directory: immortalwrt
        run: |
          echo "æ‰§è¡Œå®Œå…¨æ¸…ç†..."
          make dirclean || true
          rm -rf tmp/ staging_dir/ build_dir/ bin/

      - name: ğŸš€ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
        working-directory: immortalwrt
        run: |
          if [ -f "diy.sh" ]; then
            echo "æ‰§è¡Œç”¨æˆ· diy.sh è„šæœ¬..."
            ./diy.sh
          fi

      - name: ğŸ”„ æ›´æ–°å’Œå®‰è£… feeds
        working-directory: immortalwrt
        run: |
          echo "æ›´æ–° feeds..."
          ./scripts/feeds update -a
          echo "å®‰è£… feeds..."
          ./scripts/feeds install -a
          
          if [ "${{ github.event.inputs.include_luci }}" = "true" ]; then
            echo "å®‰è£… Luci ç›¸å…³ç»„ä»¶..."
            ./scripts/feeds install luci
            ./scripts/feeds install luci-base
          fi

      - name: âš™ï¸ ç”ŸæˆåŸºç¡€é…ç½®
        working-directory: immortalwrt
        run: |
          echo "ç”ŸæˆåŸºç¡€é…ç½®..."
          if [ -f ".config" ]; then
            echo "ä½¿ç”¨ç°æœ‰ .config æ–‡ä»¶"
            make defconfig
          else
            echo "åˆ›å»ºé»˜è®¤é…ç½®"
            # æ ¹æ®è®¾å¤‡ç±»å‹è®¾ç½®åŸºç¡€é…ç½®
            case "${{ github.event.inputs.target_device }}" in
              "mediatek/filogic")
                echo "é…ç½®ä¸º MediaTek Filogic è®¾å¤‡"
                {
                  echo "CONFIG_TARGET_mediatek=y"
                  echo "CONFIG_TARGET_mediatek_filogic=y" 
                  echo "CONFIG_TARGET_mediatek_filogic_DEVICE_glinet_gl-mt6000=y"
                } > .config
                ;;
              "qualcomm/ipq60xx")
                echo "é…ç½®ä¸º Qualcomm IPQ60xx è®¾å¤‡"
                {
                  echo "CONFIG_TARGET_qualcommax=y"
                  echo "CONFIG_TARGET_qualcommax_ipq60xx=y"
                } > .config
                ;;
              "rockchip/armv8")
                echo "é…ç½®ä¸º Rockchip ARMv8 è®¾å¤‡"
                {
                  echo "CONFIG_TARGET_rockchip=y"
                  echo "CONFIG_TARGET_rockchip_armv8=y"
                } > .config
                ;;
              "x86/64")
                echo "é…ç½®ä¸º x86/64 è®¾å¤‡"
                {
                  echo "CONFIG_TARGET_x86=y"
                  echo "CONFIG_TARGET_x86_64=y"
                } > .config
                ;;
            esac
            
            # æ·»åŠ  Luci é…ç½®
            if [ "${{ github.event.inputs.include_luci }}" = "true" ]; then
              echo "CONFIG_PACKAGE_luci=y" >> .config
            fi
            
            make defconfig
          fi

      - name: ğŸ§ª SSH è°ƒè¯•ç¯å¢ƒ
        if: ${{ github.event.inputs.ssh_debug == 'true' }}
        uses: csexton/debugger-action@master

      - name: ğŸ“¥ é¢„ä¸‹è½½æºç åŒ…
        working-directory: immortalwrt
        timeout-minutes: 30
        run: |
          echo "é¢„ä¸‹è½½æºç åŒ…..."
          make download -j$(nproc) || make download -j1
          
          echo "æ£€æŸ¥ä¸‹è½½å®Œæ•´æ€§..."
          find dl -size -1024c -exec rm -f {} \; 2>/dev/null || true
          make download -j$(nproc)

      - name: ğŸ—ï¸ ç¼–è¯‘å·¥å…·é“¾
        working-directory: immortalwrt
        timeout-minutes: 120
        run: |
          echo "=== ç¼–è¯‘å·¥å…·é“¾ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          echo "ç¼–è¯‘åŸºç¡€å·¥å…·..."
          make -j1 tools/compile
          
          echo "ç¼–è¯‘å·¥å…·é“¾..."
          make -j1 toolchain/compile
          
          if [ -d "staging_dir/toolchain-" ]; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
          
          echo "å®Œæˆæ—¶é—´: $(date)"

      - name: ğŸ§± ä¸»ç¼–è¯‘è¿‡ç¨‹
        working-directory: immortalwrt
        timeout-minutes: 180
        run: |
          echo "=== å¼€å§‹ä¸»ç¼–è¯‘ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          if [ "${{ github.event.inputs.multithreading }}" = "true" ]; then
            JOBS=$(($(nproc) - 1))
            echo "ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘ (-j$JOBS)..."
            make -j$JOBS V=s
          else
            echo "ä½¿ç”¨å•çº¿ç¨‹ç¼–è¯‘ (-j1)..."
            make -j1 V=s
          fi
          
          echo "å®Œæˆæ—¶é—´: $(date)"

      - name: ğŸ“Š ä¿å­˜ç¼–è¯‘é…ç½®
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-config-${{ needs.setup.outputs.branch_version }}
          path: |
            immortalwrt/.config
            immortalwrt/feeds.conf.default
          retention-days: 7

      - name: ğŸ“ ä¿å­˜ç¼–è¯‘æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ needs.setup.outputs.branch_version }}
          path: |
            immortalwrt/logs/
          retention-days: 3

      - name: ğŸ“¦ ä¸Šä¼ å›ºä»¶æ–‡ä»¶
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ needs.setup.outputs.branch_version }}
          path: |
            immortalwrt/bin/targets/**/*
          retention-days: 30

      - name: ğŸ‰ ç¼–è¯‘å®Œæˆæ‘˜è¦
        if: always()
        run: |
          echo "=== ç¼–è¯‘ç»“æœæ‘˜è¦ ==="
          echo "ImmortalWrt ç‰ˆæœ¬: ${{ needs.setup.outputs.immortalwrt_branch }}"
          echo "ç›®æ ‡è®¾å¤‡: ${{ github.event.inputs.target_device }}"
          echo "ç¼–è¯‘æ—¶é—´: $(date)"
          
          if [ -d "immortalwrt/bin/targets" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
            find immortalwrt/bin/targets -name "*.bin" -o -name "*.img" | head -5
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
          fi
