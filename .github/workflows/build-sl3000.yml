name: SL3000 Firmware Build

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Perform clean build (ignore cache)'
        required: false
        default: 'false'
        type: boolean

env:
  BUILD_DIR: openwrt
  CCACHE_DIR: /tmp/ccache

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    - name: Checkout repository with config
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Validate configuration file
      run: |
        echo "=== Validating build configuration ==="
        if [ ! -f "sl3000.config" ]; then
          echo "❌ ERROR: sl3000.config not found in repository root!"
          echo "Available files:"
          ls -la
          exit 1
        fi
        
        # 验证配置文件基本结构
        if grep -q "CONFIG_TARGET_mediatek_mt7981_DEVICE_sl_3000-emmc" sl3000.config; then
          echo "✅ Valid SL3000 EMMC configuration detected"
        else
          echo "⚠️  Warning: SL3000 device configuration not found in config"
        fi
        
        # 复制配置文件供后续使用
        cp sl3000.config .config
        echo "✅ Configuration file prepared"

    - name: Initialize disk space optimization
      run: |
        echo "=== Initializing disk space optimization ==="
        echo "Initial disk space:"
        df -h
        
        # 安全清理系统缓存
        sudo apt-get autoremove -y
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        
        # 清理系统日志（保留最近1小时）
        sudo journalctl --vacuum-time=1h
        sudo find /var/log -name "*.log" -type f -exec truncate -s 0 {} \; 2>/dev/null || true
        
        # 清理临时文件
        sudo rm -rf /tmp/*
        sudo rm -rf /var/tmp/*
        
        echo "Disk space after initial cleanup:"
        df -h

    - name: Install essential build dependencies
      run: |
        echo "=== Installing build dependencies ==="
        # 最小化依赖列表
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          libssl-dev \
          libncurses5-dev \
          gawk \
          gettext \
          unzip \
          python3 \
          python3-pip \
          subversion \
          git \
          wget \
          curl \
          file \
          rsync \
          ccache \
          xxd \
          gcc \
          g++ \
          make \
          bash
        
        # 验证关键工具
        echo "=== Verifying build tools ==="
        which gcc && gcc --version | head -1
        which g++ && g++ --version | head -1
        which make && make --version | head -1
        which python3 && python3 --version
        
        sudo apt-get clean

    - name: Restore build cache (if available)
      if: github.event.inputs.clean_build == 'false'
      uses: actions/cache@v4
      with:
        path: |
          /tmp/ccache
          /tmp/dl-cache
        key: ${{ runner.os }}-openwrt-sl3000-${{ hashFiles('sl3000.config') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-sl3000-

    - name: Clone ImmortalWrt source code
      run: |
        echo "=== Cloning ImmortalWrt source ==="
        
        # 检查源仓库可用性
        if ! git ls-remote https://github.com/padavanonly/immortalwrt-mt798x > /dev/null 2>&1; then
          echo "❌ ERROR: Cannot access source repository"
          echo "Trying alternative repository..."
          git ls-remote https://github.com/immortalwrt/immortalwrt > /dev/null 2>&1
        fi
        
        # 克隆源码（不指定分支，使用默认分支）
        echo "Cloning main repository..."
        git clone \
          --depth=1 \
          --filter=blob:none \
          https://github.com/padavanonly/immortalwrt-mt798x \
          $BUILD_DIR
        
        cd $BUILD_DIR
        echo "✅ Repository cloned successfully"
        echo "Using branch: $(git branch --show-current)"
        echo "Repository size:"
        du -sh .

    - name: Optimize feeds configuration
      run: |
        cd $BUILD_DIR
        echo "=== Optimizing feeds configuration ==="
        
        # 备份原始配置
        cp feeds.conf.default feeds.conf.default.backup
        
        # 移除有问题的feeds
        sed -i '/modemfeed/d' feeds.conf.default
        sed -i '/kiddin9/d' feeds.conf.default
        
        # 优化feeds配置（只保留核心feeds）
        cat > feeds.conf.default << 'EOF'
src-git packages https://git.openwrt.org/feed/packages.git;openwrt-21.02
src-git luci https://git.openwrt.org/project/luci.git;openwrt-21.02
src-git routing https://git.openwrt.org/feed/routing.git;openwrt-21.02
src-git telephony https://git.openwrt.org/feed/telephony.git;openwrt-21.02
# Problematic feeds commented out:
# src-git modemfeed https://github.com/koshev-msk/modemfeed.git
# src-git kiddin9 https://github.com/kiddin9/openwrt-packages.git
EOF
        
        echo "✅ Feeds configuration optimized"
        echo "Final feeds configuration:"
        cat feeds.conf.default

    - name: Update and install package feeds
      run: |
        cd $BUILD_DIR
        echo "=== Updating package feeds ==="
        
        # 更新feeds
        ./scripts/feeds update -a
        echo "✅ Feeds updated successfully"
        
        # 安装所有包
        ./scripts/feeds install -a
        echo "✅ Packages installed successfully"
        
        echo "Feeds directory size:"
        du -sh feeds/

    - name: Apply SL3000 configuration
      run: |
        cd $BUILD_DIR
        echo "=== Applying SL3000 configuration ==="
        
        # 从根目录复制配置文件
        if [ -f "../.config" ]; then
          cp ../.config .config
          echo "✅ Configuration applied successfully"
        else
          echo "❌ ERROR: .config file not found!"
          exit 1
        fi
        
        # 验证配置
        echo "=== Verifying target configuration ==="
        if grep -q "CONFIG_TARGET_mediatek_mt7981_DEVICE_sl_3000-emmc" .config; then
          echo "✅ SL3000 EMMC target confirmed"
        else
          echo "⚠️  Warning: SL3000 target not detected in final config"
        fi
        
        # 运行defconfig来填充缺失的配置
        echo "=== Running defconfig ==="
        make defconfig
        
        echo "=== Final configuration summary ==="
        echo "Target: $(grep "CONFIG_TARGET_mediatek_mt7981_DEVICE" .config || echo "Not found")"
        echo "Architecture: $(grep "CONFIG_TARGET_ARCH_PACKAGES" .config | head -1 || echo "Not found")"

    - name: Download package sources with resume
      run: |
        cd $BUILD_DIR
        echo "=== Downloading package sources ==="
        echo "Disk space before download:"
        df -h
        
        # 设置下载缓存
        mkdir -p /tmp/dl-cache
        if [ -d "dl" ] && [ ! -L "dl" ]; then
          echo "Moving existing dl directory to cache..."
          mv dl/* /tmp/dl-cache/ 2>/dev/null || true
          rm -rf dl
        fi
        ln -sf /tmp/dl-cache dl
        
        # 下载包源（带重试机制）
        for attempt in {1..3}; do
          echo "Download attempt $attempt..."
          if make download -j2; then
            echo "✅ Download completed successfully"
            break
          elif [ $attempt -eq 3 ]; then
            echo "❌ Download failed after 3 attempts"
            exit 1
          else
            echo "⚠️  Download attempt $attempt failed, retrying..."
            sleep 10
          fi
        done
        
        echo "Download cache size:"
        du -sh /tmp/dl-cache
        echo "Disk space after download:"
        df -h

    - name: Compile firmware with optimization
      run: |
        cd $BUILD_DIR
        echo "=== Starting firmware compilation ==="
        echo "Disk space before compilation:"
        df -h
        
        # 设置编译环境
        export FORCE_UNSAFE_CONFIGURE=1
        export CCACHE_DIR=/tmp/ccache
        ccache -o compression=true
        ccache -o max_size=2G
        
        # 显示编译信息
        echo "CPU cores: $(nproc)"
        echo "CCACHE stats:"
        ccache -s
        
        # 分阶段编译（避免内存不足）
        echo "=== Stage 1: Compiling toolchain ==="
        make toolchain/install -j$(nproc) || make toolchain/install -j2
        
        echo "=== Stage 2: Compiling kernel ==="
        make target/linux/compile -j$(nproc) || make target/linux/compile -j2
        
        echo "=== Stage 3: Compiling packages ==="
        make package/compile -j$(nproc) || make package/compile -j2
        
        echo "=== Stage 4: Creating final image ==="
        make -j$(nproc) || make -j2 || make -j1
        
        echo "✅ Compilation completed successfully"
        echo "CCACHE final stats:"
        ccache -s
        echo "Disk space after compilation:"
        df -h

    - name: Save build cache
      if: github.event.inputs.clean_build == 'false'
      uses: actions/cache@v4
      with:
        path: |
          /tmp/ccache
          /tmp/dl-cache
        key: ${{ runner.os }}-openwrt-sl3000-${{ hashFiles('sl3000.config') }}

    - name: Collect build artifacts
      run: |
        cd $BUILD_DIR
        echo "=== Collecting build artifacts ==="
        
        # 查找生成的固件文件
        echo "Generated firmware files:"
        find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) | sort
        
        # 显示文件大小
        echo "Firmware file sizes:"
        find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) -exec du -h {} \;
        
        # 验证至少有一个固件文件生成
        if [ $(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) | wc -l) -eq 0 ]; then
          echo "❌ ERROR: No firmware files generated!"
          exit 1
        fi
        
        echo "✅ Build artifacts collected successfully"

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-firmware-${{ github.sha }}
        path: |
          $BUILD_DIR/bin/targets/**/*.bin
          $BUILD_DIR/bin/targets/**/*.img
          $BUILD_DIR/bin/targets/**/*.gz
        retention-days: 30
        if-no-files-found: error
        compression-level: 0

    - name: Post-build cleanup
      if: always()
      run: |
        echo "=== Performing post-build cleanup ==="
        
        # 清理编译中间文件（保留最终镜像）
        if [ -d "$BUILD_DIR" ]; then
          cd $BUILD_DIR
          echo "Cleaning build directories..."
          rm -rf build_dir/*
          rm -rf staging_dir/*
          find . -name "tmp" -type d -exec rm -rf {} + 2>/dev/null || true
        fi
        
        echo "Final disk space:"
        df -h

    - name: Build summary
      if: always()
      run: |
        echo "=== BUILD SUMMARY ==="
        echo "Repository: ${{ github.repository }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Commit: ${{ github.sha }}"
        echo "Trigger: ${{ github.event_name }}"
        
        if [ -d "$BUILD_DIR/bin/targets" ]; then
          echo "✅ Build completed successfully"
          echo "Generated files:"
          find $BUILD_DIR/bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) | head -10
        else
          echo "❌ Build failed or no targets directory"
        fi
