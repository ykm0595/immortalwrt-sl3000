name: ğŸš€ ç¼–è¯‘ SL-3000 å›ºä»¶

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "ImmortalWrt åˆ†æ”¯"
        required: true
        default: "openwrt-24.10"
        type: string
      multithreading:
        description: "æ˜¯å¦å¼€å¯å¤šçº¿ç¨‹ç¼–è¯‘"
        default: false
        type: boolean
      ssh:
        description: "æ˜¯å¦å¼€å¯ SSH è°ƒè¯•ç¯å¢ƒ"
        default: false
        type: boolean
      isFiles:
        description: "æ˜¯å¦å¯ç”¨ files å¤§æ³•"
        default: true
        type: boolean
      clean_build:
        description: "æ˜¯å¦å®Œå…¨æ¸…ç†ç¼–è¯‘"
        default: false
        type: boolean

env:
  CCACHE_DIR: ${{ github.workspace }}/ccache
  FORCE_UNSAFE_CONFIGURE: 1

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: â¬ æ£€æŸ¥ç³»ç»Ÿèµ„æº
        run: |
          echo "=== ç³»ç»Ÿèµ„æºä¿¡æ¯ ==="
          echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
          echo "å†…å­˜ä¿¡æ¯:"
          free -h
          echo "ç£ç›˜ç©ºé—´:"
          df -h
          echo "ç³»ç»Ÿç‰ˆæœ¬:"
          lsb_release -a

      - name: âœ… Checkout è‡ªå·±ä»“åº“ï¼ˆåŒ…å« .configã€diy.shã€filesï¼‰
        uses: actions/checkout@v4
        with:
          path: source

      - name: âœ… Checkout ImmortalWrt æºç 
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: ${{ inputs.branch }}
          path: openwrt

      - name: ğŸ“ åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p openwrt
          mkdir -p ccache

      - name: ğŸ“¦ å¤åˆ¶é…ç½®æ–‡ä»¶å’Œ files
        run: |
          cp -f source/.config source/diy.sh openwrt/
          if [ "${{ inputs.isFiles }}" = "true" ] && [ -d "source/files" ]; then
            echo "å¤åˆ¶ files ç›®å½•..."
            cp -rf source/files openwrt/
          else
            echo "è·³è¿‡ files ç›®å½•å¤åˆ¶"
          fi

      - name: ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential clang flex bison g++ gawk gcc-multilib gettext git \
            libncurses-dev libssl-dev python3 python3-pip python3-serial \
            unzip zlib1g-dev file wget rsync curl vim nano swig \
            ccache ecj cmake ninja-build

      - name: ğŸ”§ è®¾ç½®ç¼–è¯‘ç¼“å­˜
        run: |
          ccache -M 4G
          ccache -s

      - name: ğŸ§¹ æ¸…ç†ç¼–è¯‘ç¯å¢ƒ
        if: ${{ inputs.clean_build == true }}
        working-directory: openwrt
        run: |
          echo "æ‰§è¡Œå®Œå…¨æ¸…ç†..."
          make dirclean
          rm -rf tmp/ staging_dir/ build_dir/

      - name: ğŸš€ æ‰§è¡Œ diy.sh
        working-directory: openwrt
        run: |
          if [ -f "diy.sh" ]; then
            echo "æ‰§è¡Œ diy.sh è„šæœ¬..."
            chmod +x diy.sh
            ./diy.sh
          else
            echo "æœªæ‰¾åˆ° diy.sh è„šæœ¬ï¼Œè·³è¿‡"
          fi

      - name: ğŸ”„ æ›´æ–° feeds
        working-directory: openwrt
        run: |
          echo "æ›´æ–° feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ğŸ§ª SSH è°ƒè¯•ç¯å¢ƒ
        if: ${{ inputs.ssh == true }}
        uses: csexton/debugger-action@master

      - name: ğŸ“Š ä¿å­˜ç¼–è¯‘å‰é…ç½®
        uses: actions/upload-artifact@v4
        with:
          name: config-before-build
          path: |
            openwrt/.config
            openwrt/feeds.conf.default
            openwrt/feeds/
          retention-days: 1

      - name: ğŸ—ï¸ ç¼–è¯‘å·¥å…·é“¾ï¼ˆå…³é”®æ­¥éª¤ï¼‰
        working-directory: openwrt
        timeout-minutes: 120
        run: |
          echo "=== å¼€å§‹ç¼–è¯‘å·¥å…·é“¾ ==="
          make defconfig
          
          # å•çº¿ç¨‹ç¼–è¯‘å·¥å…·é“¾ï¼Œé¿å…å¡ä½
          echo "ç¼–è¯‘å·¥å…·å’Œå·¥å…·é“¾..."
          make -j1 tools/compile
          make -j1 toolchain/compile
          
          # æ£€æŸ¥å·¥å…·é“¾æ˜¯å¦ç¼–è¯‘æˆåŠŸ
          if [ -d "staging_dir/toolchain-" ]; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
            ls -la staging_dir/toolchain-*/bin/ || echo "å·¥å…·é“¾ç›®å½•å­˜åœ¨ä½†å†…å®¹å¯èƒ½ä¸å®Œæ•´"
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: ğŸ§± ä¸»ç¼–è¯‘è¿‡ç¨‹
        working-directory: openwrt
        timeout-minutes: 150
        run: |
          echo "=== å¼€å§‹ä¸»ç¼–è¯‘è¿‡ç¨‹ ==="
          
          # æ£€æŸ¥å·¥å…·é“¾çŠ¶æ€
          if [ ! -d "staging_dir/toolchain-" ]; then
            echo "é”™è¯¯ï¼šå·¥å…·é“¾æœªæ‰¾åˆ°ï¼Œç¼–è¯‘ç»ˆæ­¢"
            exit 1
          fi

          if [ "${{ inputs.multithreading }}" = "true" ]; then
            echo "ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘ (-j$(nproc))..."
            make -j$(nproc) V=s
          else
            echo "ä½¿ç”¨å•çº¿ç¨‹ç¼–è¯‘ (-j1)..."
            make -j1 V=s
          fi

      - name: ğŸ“ ä¿å­˜ç¼–è¯‘æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            openwrt/build_dir/target-*/log-*
            openwrt/logs/
          retention-days: 3

      - name: ğŸ“¦ ä¸Šä¼ ç¼–è¯‘ç»“æœ
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-firmware
          path: |
            openwrt/bin/targets/**/*
            openwrt/bin/packages/**/*
          retention-days: 7

      - name: ğŸ’¾ ä¿å­˜ç¼“å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ccache-cache
          path: |
            ccache
          retention-days: 1

      - name: ğŸ“‹ ç¼–è¯‘ç»“æœæ‘˜è¦
        if: always()
        run: |
          echo "=== ç¼–è¯‘ç»“æœæ‘˜è¦ ==="
          if [ -d "openwrt/bin/targets" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸï¼å›ºä»¶æ–‡ä»¶ï¼š"
            find openwrt/bin/targets -name "*.bin" -o -name "*.img" | head -10
            echo "å›ºä»¶ä½ç½®: openwrt/bin/targets/"
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            echo "è¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
          fi
          
          echo "ç¼“å­˜çŠ¶æ€:"
          ccache -s || echo "ccache ä¸å¯ç”¨"

  diagnostics:
    runs-on: ubuntu-latest
    if: failure()
    needs: build
    steps:
      - name: ğŸ“‹ æ•…éšœè¯Šæ–­
        run: |
          echo "=== ç¼–è¯‘å¤±è´¥è¯Šæ–­ ==="
          echo "å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼š"
          echo "1. å†…å­˜ä¸è¶³ï¼šå°è¯•å…³é—­å¤šçº¿ç¨‹ç¼–è¯‘"
          echo "2. å·¥å…·é“¾é—®é¢˜ï¼šå¯ç”¨å®Œå…¨æ¸…ç†é‡æ–°ç¼–è¯‘"
          echo "3. ä¾èµ–é—®é¢˜ï¼šæ£€æŸ¥ diy.sh è„šæœ¬æ˜¯å¦æ­£ç¡®"
          echo "4. é…ç½®é”™è¯¯ï¼šéªŒè¯ .config æ–‡ä»¶æ˜¯å¦å®Œæ•´"
          echo ""
          echo "å»ºè®®ä¸‹æ¬¡ç¼–è¯‘æ—¶ï¼š"
          echo "- å…³é—­å¤šçº¿ç¨‹ç¼–è¯‘"
          echo "- å¯ç”¨å®Œå…¨æ¸…ç†"
          echo "- æ£€æŸ¥ç¼–è¯‘æ—¥å¿—ä¸­çš„å…·ä½“é”™è¯¯"

      - name: ğŸ“¤ ä¸‹è½½æ—¥å¿—æç¤º
        run: |
          echo "è¯·ä» Artifacts ä¸‹è½½å®Œæ•´ç¼–è¯‘æ—¥å¿—è¿›è¡Œåˆ†æ"
          echo "é‡ç‚¹å…³æ³¨ build-logs ä¸­çš„é”™è¯¯ä¿¡æ¯"
