name: ğŸš€ ç¼–è¯‘ SL-3000 ImmortalWrt å›ºä»¶

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "ImmortalWrt åˆ†æ”¯"
        type: string
        required: true
        default: "openwrt-24.10"
      multithreading:
        description: "æ˜¯å¦å¼€å¯å¤šçº¿ç¨‹ç¼–è¯‘"
        type: boolean
        default: true
      ssh:
        description: "æ˜¯å¦å¼€å¯ SSH è°ƒè¯•ç¯å¢ƒ"
        type: boolean
        default: false
      isFiles:
        description: "æ˜¯å¦å¯ç”¨ files å¤§æ³•"
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    name: ğŸš€ ç¼–è¯‘ SL-3000 å›ºä»¶
    steps:
      - name: æŸ¥çœ‹ç£ç›˜ç©ºé—´
        run: df -hT

      - name: ä¼˜åŒ–ç£ç›˜ç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 3072
          swap-size-mb: 1
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          remove-codeql: "true"
          remove-docker-images: "true"

      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gettext gcc-multilib g++-multilib git gnutls-dev gperf intltool lib32gcc-s1 libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano ninja-build p7zip-full patch pkgconf python3 python3-pip qemu-utils rsync squashfs-tools subversion swig texinfo unzip vim wget xmlto xxd zlib1g-dev zstd

      - name: å…‹éš† ImmortalWrt æºç 
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: ${{ inputs.branch }}
          path: openwrt

      - name: å¤åˆ¶é…ç½®æ–‡ä»¶
        run: |
          cp -f .config diy.sh openwrt/
          if [ "${{ inputs.isFiles }}" = "true" ]; then
            cp -r files openwrt/files
          fi

      - name: è¿è¡Œ diy.sh
        working-directory: openwrt
        run: |
          chmod +x diy.sh
          ./diy.sh

      - name: æ›´æ–° feeds
        working-directory: openwrt
        run: ./scripts/feeds update -a && ./scripts/feeds install -a

      - name: SSH è°ƒè¯•ç¯å¢ƒ
        if: ${{ inputs.ssh == true }}
        uses: csexton/debugger-action@master

      - name: ä¿å­˜ç¼–è¯‘å‰é…ç½®
        uses: actions/upload-artifact@v4
        with:
          name: config-before-build
          path: |
            openwrt/.config
            openwrt/feeds.conf.default
          include-hidden-files: true

      - name: ç¼–è¯‘ SL-3000 å›ºä»¶ (å¤šçº¿ç¨‹)
        if: ${{ inputs.multithreading == true }}
        working-directory: openwrt
        run: make -j$(nproc) V=s

      - name: ç¼–è¯‘ SL-3000 å›ºä»¶ (å•çº¿ç¨‹)
        if: ${{ inputs.multithreading == false }}
        working-directory: openwrt
        run: make -j1 V=s

      - name: ä¸Šä¼ ç¼–è¯‘ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-build-result
          path: openwrt/bin/targets
