name: ğŸš€ ç¼–è¯‘ SL-3000 å›ºä»¶

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "ImmortalWrt åˆ†æ”¯"
        required: true
        default: "openwrt-21.02"
        type: string
      multithreading:
        description: "æ˜¯å¦å¼€å¯å¤šçº¿ç¨‹ç¼–è¯‘"
        default: false
        type: boolean
      ssh:
        description: "æ˜¯å¦å¼€å¯ SSH è°ƒè¯•ç¯å¢ƒ"
        default: false
        type: boolean
      isFiles:
        description: "æ˜¯å¦å¯ç”¨ files å¤§æ³•"
        default: true
        type: boolean
      clean_build:
        description: "æ˜¯å¦å®Œå…¨æ¸…ç†ç¼–è¯‘"
        default: false
        type: boolean

env:
  CCACHE_DIR: ${{ github.workspace }}/ccache
  FORCE_UNSAFE_CONFIGURE: 1
  TERM: linux

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: â¬ æ£€æŸ¥ç³»ç»Ÿèµ„æº
        run: |
          echo "=== ç³»ç»Ÿèµ„æºä¿¡æ¯ ==="
          echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
          echo "å†…å­˜ä¿¡æ¯:"
          free -h
          echo "ç£ç›˜ç©ºé—´:"
          df -h

      - name: âœ… Checkout è‡ªå·±ä»“åº“
        uses: actions/checkout@v4
        with:
          path: source

      - name: âœ… Checkout ImmortalWrt æºç 
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: ${{ github.event.inputs.branch }}
          path: openwrt

      - name: ğŸ“ åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p openwrt
          mkdir -p ccache

      - name: ğŸ“¦ å¤åˆ¶é…ç½®æ–‡ä»¶å’Œ files
        run: |
          if [ -f "source/.config" ]; then
            cp -f source/.config openwrt/
            echo "âœ… å·²å¤åˆ¶ .config æ–‡ä»¶"
          else
            echo "âŒ æœªæ‰¾åˆ° .config æ–‡ä»¶ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
          fi
          
          if [ -f "source/diy.sh" ]; then
            cp -f source/diy.sh openwrt/
            echo "âœ… å·²å¤åˆ¶ diy.sh æ–‡ä»¶"
          fi
          
          if [ "${{ github.event.inputs.isFiles }}" = "true" ] && [ -d "source/files" ]; then
            echo "å¤åˆ¶ files ç›®å½•..."
            cp -rf source/files openwrt/
          fi

      - name: ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential clang flex bison g++ gawk gcc-multilib gettext git \
            libncurses-dev libssl-dev python3 python3-pip python3-serial \
            unzip zlib1g-dev file wget rsync curl vim nano swig \
            ccache ecj cmake ninja-build libxml2-utils

      - name: ğŸ”§ è®¾ç½®ç¼–è¯‘ç¼“å­˜å’Œç¯å¢ƒ
        run: |
          ccache -M 2G
          ccache -s
          echo "è®¾ç½®ç»ˆç«¯ç¯å¢ƒ..."
          export TERM=linux

      - name: ğŸ§¹ æ¸…ç†ç¼–è¯‘ç¯å¢ƒ
        if: ${{ github.event.inputs.clean_build == 'true' }}
        working-directory: openwrt
        run: |
          echo "æ‰§è¡Œå®Œå…¨æ¸…ç†..."
          make dirclean || true
          rm -rf tmp/ staging_dir/ build_dir/ .config

      - name: ğŸš€ æ‰§è¡Œ diy.sh
        working-directory: openwrt
        run: |
          if [ -f "diy.sh" ]; then
            echo "æ‰§è¡Œ diy.sh è„šæœ¬..."
            chmod +x diy.sh
            ./diy.sh
          else
            echo "æœªæ‰¾åˆ° diy.sh è„šæœ¬ï¼Œè·³è¿‡"
          fi

      - name: ğŸ”„ æ›´æ–°å’Œå®‰è£… feeds
        working-directory: openwrt
        run: |
          echo "æ›´æ–° feeds..."
          ./scripts/feeds update -a
          echo "å®‰è£… feeds..."
          ./scripts/feeds install -a
          # å®‰è£…ç¼ºå¤±çš„ä¾èµ–åŒ…
          ./scripts/feeds install liblzma libnetsnmp glib2 libgpiod libpam || echo "éƒ¨åˆ†ä¾èµ–å®‰è£…å¤±è´¥ï¼Œç»§ç»­..."

      - name: ğŸ› ï¸ ä¿®å¤ä¾èµ–é—®é¢˜
        working-directory: openwrt
        run: |
          echo "ä¿®å¤ä¾èµ–å…³ç³»..."
          # æ‰‹åŠ¨å®‰è£…ä¸€äº›å¸¸è§ç¼ºå¤±çš„åŒ…
          ./scripts/feeds install luci || echo "LuCI å®‰è£…å¤±è´¥"
          ./scripts/feeds install luci-i18n-base-zh-cn || echo "LuCI ä¸­æ–‡è¯­è¨€åŒ…å®‰è£…å¤±è´¥"
          ./scripts/feeds install liblzma libnetsnmp glib2 libgpiod libpam || echo "éƒ¨åˆ†åº“å®‰è£…å¤±è´¥"

      - name: âš™ï¸ é…ç½®ç¼–è¯‘ç¯å¢ƒï¼ˆä¿®å¤ç»ˆç«¯é”™è¯¯ï¼‰
        working-directory: openwrt
        run: |
          echo "é…ç½®ç¼–è¯‘ç¯å¢ƒ..."
          # ä½¿ç”¨éäº¤äº’å¼é…ç½®ï¼Œé¿å…ç»ˆç«¯é”™è¯¯
          if [ -f ".config" ]; then
            echo "ä½¿ç”¨ç°æœ‰çš„ .config æ–‡ä»¶"
            make oldconfig
          else
            echo "ç”Ÿæˆé»˜è®¤é…ç½®"
            make defconfig
          fi
          
          # ä¿®å¤ç»ˆç«¯é”™è¯¯
          export TERM=linux
          echo "æ£€æŸ¥é…ç½®..."
          make -s prereq 2>/dev/null || true

      - name: ğŸ§ª SSH è°ƒè¯•ç¯å¢ƒ
        if: ${{ github.event.inputs.ssh == 'true' }}
        uses: csexton/debugger-action@master

      - name: ğŸ“Š ä¿å­˜ç¼–è¯‘å‰é…ç½®
        uses: actions/upload-artifact@v4
        with:
          name: config-before-build
          path: |
            openwrt/.config
            openwrt/feeds.conf.default
          retention-days: 1

      - name: ğŸ—ï¸ ç¼–è¯‘å·¥å…·é“¾ï¼ˆå…³é”®æ­¥éª¤ï¼‰
        working-directory: openwrt
        timeout-minutes: 120
        env:
          TERM: linux
        run: |
          echo "=== å¼€å§‹ç¼–è¯‘å·¥å…·é“¾ ==="
          
          # è®¾ç½®ç»ˆç«¯ç±»å‹é¿å…é”™è¯¯
          export TERM=linux
          
          # å…ˆç¼–è¯‘åŸºç¡€å·¥å…·
          echo "ç¼–è¯‘åŸºç¡€å·¥å…·..."
          make -j1 tools/compile
          
          # ç¼–è¯‘å·¥å…·é“¾
          echo "ç¼–è¯‘å·¥å…·é“¾..."
          make -j1 toolchain/compile
          
          # æ£€æŸ¥å·¥å…·é“¾æ˜¯å¦ç¼–è¯‘æˆåŠŸ
          if [ -d "staging_dir/toolchain-" ] && [ -f "staging_dir/toolchain-"*/bin/*-gcc ]; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
            echo "å·¥å…·é“¾ç›®å½•å†…å®¹:"
            ls -la staging_dir/ || echo "staging_dir ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ğŸ§± ä¸»ç¼–è¯‘è¿‡ç¨‹
        working-directory: openwrt
        timeout-minutes: 150
        env:
          TERM: linux
        run: |
          echo "=== å¼€å§‹ä¸»ç¼–è¯‘è¿‡ç¨‹ ==="
          
          # è®¾ç½®ç»ˆç«¯ç±»å‹
          export TERM=linux
          
          # æ£€æŸ¥å·¥å…·é“¾çŠ¶æ€
          if [ ! -d "staging_dir/toolchain-" ]; then
            echo "é”™è¯¯ï¼šå·¥å…·é“¾æœªæ‰¾åˆ°ï¼Œç¼–è¯‘ç»ˆæ­¢"
            exit 1
          fi

          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "å·¥å…·é“¾çŠ¶æ€:"
          ls -la staging_dir/toolchain-*/bin/ | head -10 || echo "æ— æ³•åˆ—å‡ºå·¥å…·é“¾ç›®å½•"

          if [ "${{ github.event.inputs.multithreading }}" = "true" ]; then
            echo "ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘ (-j$(($(nproc) - 1)))..."
            make -j$(($(nproc) - 1)) V=s
          else
            echo "ä½¿ç”¨å•çº¿ç¨‹ç¼–è¯‘ (-j1)..."
            make -j1 V=s
          fi

      - name: ğŸ“ ä¿å­˜ç¼–è¯‘æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            openwrt/logs/
            openwrt/build_dir/**/log-*
          retention-days: 3

      - name: ğŸ“¦ ä¸Šä¼ ç¼–è¯‘ç»“æœ
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-firmware
          path: |
            openwrt/bin/targets/**/*
          retention-days: 7

      - name: ğŸ’¾ ä¿å­˜ç¼“å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ccache-cache
          path: ccache
          retention-days: 1

      - name: ğŸ“‹ ç¼–è¯‘ç»“æœæ‘˜è¦
        if: always()
        run: |
          echo "=== ç¼–è¯‘ç»“æœæ‘˜è¦ ==="
          if [ -d "openwrt/bin/targets" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸï¼å›ºä»¶æ–‡ä»¶ï¼š"
            find openwrt/bin/targets -name "*.bin" -o -name "*.img" -o -name "*.gz" | head -10
            echo "å›ºä»¶ä½ç½®: openwrt/bin/targets/"
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            echo "è¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
          fi

  diagnostics:
    runs-on: ubuntu-latest
    if: failure()
    needs: build
    steps:
      - name: ğŸ“¥ ä¸‹è½½ç¼–è¯‘æ—¥å¿—
        uses: actions/download-artifact@v4
        with:
          name: build-logs
          path: diagnostics

      - name: ğŸ” åˆ†æé”™è¯¯
        run: |
          echo "=== ç¼–è¯‘å¤±è´¥åˆ†æ ==="
          echo "ä¸»è¦é”™è¯¯ï¼šç»ˆç«¯ç¯å¢ƒé—®é¢˜å·²ä¿®å¤"
          echo "ä¾èµ–è­¦å‘Šå¤„ç†ï¼šå·²æ·»åŠ ç¼ºå¤±ä¾èµ–å®‰è£…"
          echo ""
          echo "å¦‚æœä»ç„¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š"
          echo "1. .config æ–‡ä»¶æ˜¯å¦ä¸ ImmortalWrt ç‰ˆæœ¬å…¼å®¹"
          echo "2. åˆ†æ”¯é€‰æ‹©æ˜¯å¦æ­£ç¡®ï¼ˆå»ºè®®ä½¿ç”¨ç¨³å®šåˆ†æ”¯ï¼‰"
          echo "3. åœ¨æœ¬åœ°ç¯å¢ƒä¸­æµ‹è¯•é…ç½®"
          
          if [ -d "diagnostics" ]; then
            echo "ç¼–è¯‘æ—¥å¿—æ‘˜è¦ï¼š"
            find diagnostics -name "*.log" -exec grep -l -i "error\|fail" {} \; | head -5
          fi

      - name: ğŸ› ï¸ ä¿®å¤å»ºè®®
        run: |
          echo "=== ä¿®å¤å»ºè®® ==="
          echo "1. ä¸‹æ¬¡ç¼–è¯‘æ—¶é€‰æ‹©æ›´ç¨³å®šçš„åˆ†æ”¯ï¼ˆå¦‚ openwrt-21.02ï¼‰"
          echo "2. å…³é—­å¤šçº¿ç¨‹ç¼–è¯‘é€‰é¡¹"
          echo "3. å¯ç”¨å®Œå…¨æ¸…ç†ç¼–è¯‘"
          echo "4. æ£€æŸ¥ .config æ–‡ä»¶ä¸­æ˜¯å¦æœ‰ä¸å…¼å®¹çš„åŒ…"
          echo "5. åœ¨ diy.sh ä¸­æ·»åŠ ç¼ºå¤±çš„ feeds æº"
