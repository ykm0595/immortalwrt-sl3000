name: ğŸš€ ç¼–è¯‘ ImmortalWrt æœ€æ–°ç¨³å®šç‰ˆ

on:
  workflow_dispatch:
    inputs:
      target_device:
        description: "ç›®æ ‡è®¾å¤‡"
        required: true
        default: "mediatek/filogic"
        type: choice
        options:
          - mediatek/filogic
          - qualcomm/ipq60xx
          - rockchip/armv8
          - x86/64
      clean_build:
        description: "æ˜¯å¦å®Œå…¨æ¸…ç†ç¼–è¯‘"
        default: false
        type: boolean
      multithreading:
        description: "æ˜¯å¦å¼€å¯å¤šçº¿ç¨‹ç¼–è¯‘"
        default: false
        type: boolean
      include_luci:
        description: "æ˜¯å¦åŒ…å« Luci Web ç•Œé¢"
        default: true
        type: boolean
      ssh_debug:
        description: "æ˜¯å¦å¼€å¯ SSH è°ƒè¯•"
        default: false
        type: boolean

env:
  CCACHE_DIR: ${{ github.workspace }}/ccache
  FORCE_UNSAFE_CONFIGURE: 1
  TERM: linux

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      immortalwrt_branch: ${{ steps.get_branch.outputs.branch }}
      branch_version: ${{ steps.get_branch.outputs.version }}
    steps:
      - name: ğŸ” è·å–æœ€æ–°ç¨³å®šç‰ˆåˆ†æ”¯
        id: get_branch
        run: |
          # è·å– ImmortalWrt æœ€æ–°çš„ç¨³å®šç‰ˆåˆ†æ”¯
          LATEST_STABLE=$(curl -s https://api.github.com/repos/immortalwrt/immortalwrt/branches | grep -o '"name":"openwrt-[0-9]*\.[0-9]*"' | head -1 | cut -d'"' -f4)
          if [ -z "$LATEST_STABLE" ]; then
            LATEST_STABLE="openwrt-24.10"
          fi
          echo "branch=$LATEST_STABLE" >> $GITHUB_OUTPUT
          VERSION=$(echo $LATEST_STABLE | sed 's/openwrt-//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… æ£€æµ‹åˆ°æœ€æ–°ç¨³å®šç‰ˆ: $LATEST_STABLE (ç‰ˆæœ¬ $VERSION)"

  build:
    runs-on: ubuntu-22.04
    needs: setup
    timeout-minutes: 240
    
    steps:
      - name: ğŸ“‹ æ˜¾ç¤ºç¼–è¯‘ä¿¡æ¯
        run: |
          echo "=== ImmortalWrt ç¼–è¯‘ä¿¡æ¯ ==="
          echo "ç›®æ ‡è®¾å¤‡: ${{ github.event.inputs.target_device }}"
          echo "ImmortalWrt åˆ†æ”¯: ${{ needs.setup.outputs.immortalwrt_branch }}"
          echo "å›ºä»¶ç‰ˆæœ¬: ${{ needs.setup.outputs.branch_version }}"
          echo "å¤šçº¿ç¨‹ç¼–è¯‘: ${{ github.event.inputs.multithreading }}"
          echo "åŒ…å« Luci: ${{ github.event.inputs.include_luci }}"

      - name: â¬ æ£€æŸ¥ç³»ç»Ÿèµ„æº
        run: |
          echo "=== ç³»ç»Ÿèµ„æºä¿¡æ¯ ==="
          echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
          echo "å†…å­˜ä¿¡æ¯:"
          free -h
          echo "ç£ç›˜ç©ºé—´:"
          df -h
          echo "ç³»ç»Ÿç‰ˆæœ¬:"
          lsb_release -a

      - name: âœ… Checkout ç”¨æˆ·é…ç½®ä»“åº“
        uses: actions/checkout@v4
        with:
          path: user-configs

      - name: âœ… Checkout ImmortalWrt æºç 
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: ${{ needs.setup.outputs.immortalwrt_branch }}
          path: immortalwrt

      - name: ğŸ“ åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p immortalwrt
          mkdir -p ccache
          mkdir -p dl-cache

      - name: ğŸ› ï¸ å®‰è£…å®Œæ•´ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update
          sudo apt full-upgrade -y
          sudo apt install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk \
            gettext gcc-multilib g++-multilib git gnutls-dev gperf haveged help2man \
            intltool lib32gcc-s1 libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev \
            libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev libreadline-dev \
            libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano \
            ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply \
            python3-docutils python3-pyelftools qemu-utils re2c rsync scons squashfs-tools \
            subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd

      - name: ğŸ”§ é…ç½®ç¼–è¯‘ç¯å¢ƒå’Œç¼“å­˜
        run: |
          ccache -M 4G
          ccache -s
          echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV

      - name: ğŸ“¦ å¤åˆ¶ç”¨æˆ·é…ç½®æ–‡ä»¶
        run: |
          echo "å¤åˆ¶ç”¨æˆ·é…ç½®æ–‡ä»¶..."
          if [ -f "user-configs/.config" ]; then
            cp -f user-configs/.config immortalwrt/
            echo "âœ… å·²å¤åˆ¶ .config æ–‡ä»¶"
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°ç”¨æˆ· .configï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
          fi
          
          if [ -f "user-configs/diy.sh" ]; then
            cp -f user-configs/diy.sh immortalwrt/
            chmod +x immortalwrt/diy.sh
            echo "âœ… å·²å¤åˆ¶ diy.sh"
          fi
          
          if [ -d "user-configs/files" ]; then
            cp -rf user-configs/files immortalwrt/
            echo "âœ… å·²å¤åˆ¶ files ç›®å½•"
          fi

      - name: ğŸ§¹ æ¸…ç†ç¼–è¯‘ç¯å¢ƒ
        if: ${{ github.event.inputs.clean_build == 'true' }}
        working-directory: immortalwrt
        run: |
          echo "æ‰§è¡Œå®Œå…¨æ¸…ç†..."
          make distclean || make dirclean || true
          rm -rf tmp/ staging_dir/ build_dir/ bin/

      - name: ğŸš€ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
        working-directory: immortalwrt
        run: |
          if [ -f "diy.sh" ]; then
            echo "æ‰§è¡Œç”¨æˆ· diy.sh è„šæœ¬..."
            chmod +x diy.sh
            ./diy.sh
          fi

      - name: ğŸ”„ æ›´æ–°å’Œå®‰è£… feeds
        working-directory: immortalwrt
        run: |
          echo "æ›´æ–° feeds..."
          ./scripts/feeds update -a
          echo "å®‰è£… feeds..."
          ./scripts/feeds install -a
          
          # ç¡®ä¿å®‰è£…åŸºæœ¬ç»„ä»¶
          if [ "${{ github.event.inputs.include_luci }}" = "true" ]; then
            echo "å®‰è£… Luci ç›¸å…³ç»„ä»¶..."
            ./scripts/feeds install luci
            ./scripts/feeds install luci-base
            ./scripts/feeds install luci-compat
          fi

      - name: âš™ï¸ ç”ŸæˆåŸºç¡€é…ç½®
        working-directory: immortalwrt
        run: |
          echo "ç”ŸæˆåŸºç¡€é…ç½®..."
          if [ -f ".config" ]; then
            echo "ä½¿ç”¨ç°æœ‰ .config æ–‡ä»¶"
            make defconfig
          else
            echo "åˆ›å»ºé»˜è®¤é…ç½®"
            # æ ¹æ®è®¾å¤‡ç±»å‹è®¾ç½®åŸºç¡€é…ç½®
            case "${{ github.event.inputs.target_device }}" in
              "mediatek/filogic")
                echo "é…ç½®ä¸º MediaTek Filogic è®¾å¤‡"
                cat > .config << EOF
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_filogic=y
CONFIG_TARGET_mediatek_filogic_DEVICE_glinet_gl-mt6000=y
$(if [ "${{ github.event.inputs.include_luci }}" = "true" ]; then echo "CONFIG_PACKAGE_luci=y"; fi)
EOF
                ;;
              "qualcomm/ipq60xx")
                echo "é…ç½®ä¸º Qualcomm IPQ60xx è®¾å¤‡"
                cat > .config << EOF
CONFIG_TARGET_qualcommax=y
CONFIG_TARGET_qualcommax_ipq60xx=y
$(if [ "${{ github.event.inputs.include_luci }}" = "true" ]; then echo "CONFIG_PACKAGE_luci=y"; fi)
EOF
                ;;
              "rockchip/armv8")
                echo "é…ç½®ä¸º Rockchip ARMv8 è®¾å¤‡"
                cat > .config << EOF
CONFIG_TARGET_rockchip=y
CONFIG_TARGET_rockchip_armv8=y
$(if [ "${{ github.event.inputs.include_luci }}" = "true" ]; then echo "CONFIG_PACKAGE_luci=y"; fi)
EOF
                ;;
              "x86/64")
                echo "é…ç½®ä¸º x86/64 è®¾å¤‡"
                cat > .config << EOF
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
$(if [ "${{ github.event.inputs.include_luci }}" = "true" ]; then echo "CONFIG_PACKAGE_luci=y"; fi)
EOF
                ;;
            esac
            make defconfig
          fi

      - name: ğŸ§ª SSH è°ƒè¯•ç¯å¢ƒ
        if: ${{ github.event.inputs.ssh_debug == 'true' }}
        uses: csexton/debugger-action@master

      - name: ğŸ“¥ é¢„ä¸‹è½½æºç åŒ…
        working-directory: immortalwrt
        timeout-minutes: 30
        run: |
          echo "é¢„ä¸‹è½½æºç åŒ…..."
          make download -j$(nproc) || make download -j1
          
          # æ£€æŸ¥å¹¶é‡æ–°ä¸‹è½½ä¸å®Œæ•´çš„æ–‡ä»¶
          echo "æ£€æŸ¥ä¸‹è½½å®Œæ•´æ€§..."
          find dl -size -1024c -name "*.gz" -o -name "*.bz2" -o -name "*.xz" | while read file; do
            if [ -f "$file" ]; then
              echo "é‡æ–°ä¸‹è½½ä¸å®Œæ•´æ–‡ä»¶: $file"
              rm -f "$file"
            fi
          done
          make download -j$(nproc)

      - name: ğŸ—ï¸ ç¼–è¯‘å·¥å…·é“¾
        working-directory: immortalwrt
        timeout-minutes: 120
        run: |
          echo "=== ç¼–è¯‘å·¥å…·é“¾ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          # å•çº¿ç¨‹ç¼–è¯‘å·¥å…·é“¾ç¡®ä¿ç¨³å®šæ€§
          echo "ç¼–è¯‘åŸºç¡€å·¥å…·..."
          make -j1 tools/compile
          
          echo "ç¼–è¯‘å·¥å…·é“¾..."
          make -j1 toolchain/compile
          
          # éªŒè¯å·¥å…·é“¾
          if [ -d "staging_dir/toolchain-" ] && find staging_dir/toolchain-*/bin -name "*gcc" | grep -q .; then
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
            echo "å·¥å…·é“¾æ–‡ä»¶:"
            ls -la staging_dir/toolchain-*/bin/*gcc | head -5
          else
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
          
          echo "å®Œæˆæ—¶é—´: $(date)"

      - name: ğŸ§± ä¸»ç¼–è¯‘è¿‡ç¨‹
        working-directory: immortalwrt
        timeout-minutes: 180
        run: |
          echo "=== å¼€å§‹ä¸»ç¼–è¯‘ ==="
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          # è®¾ç½®ç¼–è¯‘çº¿ç¨‹æ•°
          if [ "${{ github.event.inputs.multithreading }}" = "true" ]; then
            JOBS=$(($(nproc) - 1))
            echo "ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘ (-j$JOBS)..."
            make -j$JOBS V=s
          else
            echo "ä½¿ç”¨å•çº¿ç¨‹ç¼–è¯‘ (-j1)..."
            make -j1 V=s
          fi
          
          echo "å®Œæˆæ—¶é—´: $(date)"

      - name: ğŸ“Š ä¿å­˜ç¼–è¯‘é…ç½®
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-config-${{ needs.setup.outputs.branch_version }}
          path: |
            immortalwrt/.config
            immortalwrt/feeds.conf.default
          retention-days: 7

      - name: ğŸ“ ä¿å­˜ç¼–è¯‘æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ needs.setup.outputs.branch_version }}
          path: |
            immortalwrt/logs/
            immortalwrt/build_dir/**/log-*
          retention-days: 3

      - name: ğŸ“¦ ä¸Šä¼ å›ºä»¶æ–‡ä»¶
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ needs.setup.outputs.branch_version }}-${{ github.event.inputs.target_device }}
          path: |
            immortalwrt/bin/targets/**/*
          retention-days: 30

      - name: ğŸ’¾ ä¿å­˜ç¼–è¯‘ç¼“å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ccache-cache-${{ needs.setup.outputs.branch_version }}
          path: ccache
          retention-days: 2

      - name: ğŸ‰ ç¼–è¯‘å®Œæˆæ‘˜è¦
        if: always()
        run: |
          echo "=== ç¼–è¯‘ç»“æœæ‘˜è¦ ==="
          echo "ImmortalWrt ç‰ˆæœ¬: ${{ needs.setup.outputs.immortalwrt_branch }}"
          echo "ç›®æ ‡è®¾å¤‡: ${{ github.event.inputs.target_device }}"
          echo "ç¼–è¯‘æ—¶é—´: $(date)"
          
          if [ -d "immortalwrt/bin/targets" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
            echo "ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶:"
            find immortalwrt/bin/targets -name "*.bin" -o -name "*.img" -o -name "*.gz" | head -10
            echo ""
            echo "å›ºä»¶ä½ç½®: immortalwrt/bin/targets/"
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            echo "è¯·æŸ¥çœ‹ build-logs æ—¥å¿—æ–‡ä»¶åˆ†æé—®é¢˜"
          fi
          
          echo "ç¼“å­˜çŠ¶æ€:"
          ccache -s 2>/dev/null || echo "ccache ä¸å¯ç”¨"

  diagnostics:
    runs-on: ubuntu-22.04
    if: failure()
    needs: [setup, build]
    steps:
      - name: ğŸ“¥ ä¸‹è½½ç¼–è¯‘æ—¥å¿—
        uses: actions/download-artifact@v4
        with:
          pattern: build-logs-*
          path: diagnostics

      - name: ğŸ” åˆ†æç¼–è¯‘é”™è¯¯
        run: |
          echo "=== ç¼–è¯‘å¤±è´¥åˆ†æ ==="
          echo "ImmortalWrt ç‰ˆæœ¬: ${{ needs.setup.outputs.immortalwrt_branch }}"
          echo ""
          echo "å¸¸è§é—®é¢˜æ’æŸ¥:"
          echo "1. ä¾èµ–ç¼ºå¤±: æ£€æŸ¥ feeds æ˜¯å¦å®Œæ•´å®‰è£…"
          echo "2. å·¥å…·é“¾é—®é¢˜: ç¡®è®¤å·¥å…·é“¾ç¼–è¯‘æ˜¯å¦æˆåŠŸ"
          echo "3. å†…å­˜ä¸è¶³: å°è¯•å…³é—­å¤šçº¿ç¨‹ç¼–è¯‘"
          echo "4. ç½‘ç»œè¶…æ—¶: æ£€æŸ¥ä¸‹è½½çš„æºç åŒ…æ˜¯å¦å®Œæ•´"
          echo ""
          
          if [ -d "diagnostics" ]; then
            echo "å‘ç°çš„é”™è¯¯æ—¥å¿—:"
            find diagnostics -name "*.log" -exec grep -l -i "error\|fail" {} \; | head -5
          fi

      - name: ğŸ› ï¸ ä¿®å¤å»ºè®®
        run: |
          echo "=== ä¿®å¤å»ºè®® ==="
          echo "1. å¯ç”¨å®Œå…¨æ¸…ç†ç¼–è¯‘ (clean_build: true)"
          echo "2. å…³é—­å¤šçº¿ç¨‹ç¼–è¯‘ (multithreading: false)" 
          echo "3. æ£€æŸ¥ .config æ–‡ä»¶é…ç½®æ˜¯å¦æ­£ç¡®"
          echo "4. ç¡®ä¿æ‰€æœ‰ feeds æˆåŠŸæ›´æ–°å’Œå®‰è£…"
          echo "5. éªŒè¯ç£ç›˜ç©ºé—´å……è¶³ (è‡³å°‘ 20GB å¯ç”¨)"
          echo ""
          echo "ä¸‹æ¬¡ç¼–è¯‘å»ºè®®:"
          echo "- ä½¿ç”¨å•çº¿ç¨‹ç¼–è¯‘ç¡®ä¿ç¨³å®šæ€§"
          echo "- å¯ç”¨å®Œå…¨æ¸…ç†é¿å…ç¼“å­˜é—®é¢˜"
          echo "- æ£€æŸ¥è®¾å¤‡é…ç½®æ˜¯å¦ä¸åˆ†æ”¯å…¼å®¹"

      - name: ğŸ“¤ ä¸Šä¼ è¯Šæ–­æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: diagnostics-report
          path: diagnostics
          retention-days: 3
