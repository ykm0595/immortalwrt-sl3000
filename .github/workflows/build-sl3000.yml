name: ğŸš€ ç¼–è¯‘ SL-3000 å›ºä»¶

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "ImmortalWrt åˆ†æ”¯"
        required: true
        default: "openwrt-24.10"
        type: string
      multithreading:
        description: "æ˜¯å¦å¼€å¯å¤šçº¿ç¨‹ç¼–è¯‘"
        default: true
        type: boolean
      ssh:
        description: "æ˜¯å¦å¼€å¯ SSH è°ƒè¯•ç¯å¢ƒ"
        default: false
        type: boolean
      isFiles:
        description: "æ˜¯å¦å¯ç”¨ files å¤§æ³•"
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: âœ… Checkout è‡ªå·±ä»“åº“ï¼ˆåŒ…å« .configã€diy.shã€filesï¼‰
        uses: actions/checkout@v4

      - name: âœ… Checkout ImmortalWrt æºç 
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: ${{ inputs.branch }}
          path: openwrt

      - name: ğŸ“ åˆ›å»º openwrt ç›®å½•ï¼ˆä¿é™©ï¼‰
        run: mkdir -p openwrt

      - name: ğŸ“¦ å¤åˆ¶é…ç½®æ–‡ä»¶å’Œ files
        run: |
          cp -f .config diy.sh openwrt/
          if [ "${{ inputs.isFiles }}" = "true" ]; then
            cp -r files openwrt/files
          fi

      - name: ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential clang flex bison g++ gawk gcc-multilib gettext git libncurses-dev libssl-dev \
            python3 python3-pip unzip zlib1g-dev file wget rsync curl vim nano

      - name: ğŸš€ æ‰§è¡Œ diy.sh
        working-directory: openwrt
        run: |
          chmod +x diy.sh
          ./diy.sh

      - name: ğŸ”„ æ›´æ–° feeds
        working-directory: openwrt
        run: ./scripts/feeds update -a && ./scripts/feeds install -a

      - name: ğŸ§ª SSH è°ƒè¯•ç¯å¢ƒ
        if: ${{ inputs.ssh == true }}
        uses: csexton/debugger-action@master

      - name: ğŸ§¾ ä¿å­˜ç¼–è¯‘å‰é…ç½®
        uses: actions/upload-artifact@v4
        with:
          name: config-before-build
          path: |
            openwrt/.config
            openwrt/feeds.conf.default
          include-hidden-files: true

      - name: ğŸ§± ç¼–è¯‘å›ºä»¶
        working-directory: openwrt
        run: |
          make defconfig
          if [ "${{ inputs.multithreading }}" = "true" ]; then
            make -j$(nproc) V=s
          else
            make -j1 V=s
          fi

      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-build-result
          path: openwrt/bin/targets
